/*
 * generated by Xtext 2.20.0
 */
package com.jsantos.metadata.plugin.validation;

import java.io.File;
import java.util.ArrayList;
import java.util.Vector;

import org.eclipse.core.resources.ResourcesPlugin;
import org.eclipse.core.runtime.Path;
import org.eclipse.emf.common.util.URI;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.xtext.validation.Check;

import com.jsantos.metadata.plugin.accessors.EntityHelper;
import com.jsantos.metadata.plugin.accessors.PatternHelper;
import com.jsantos.metadata.plugin.metaDsl.Attribute;
import com.jsantos.metadata.plugin.metaDsl.Entity;
import com.jsantos.metadata.plugin.metaDsl.MetaDslPackage;
import com.jsantos.metadata.plugin.metaDsl.Metadata;
import com.jsantos.metadata.plugin.metaDsl.MetadataRow;
import com.jsantos.metadata.plugin.metaDsl.MetadataRowCell;
import com.jsantos.metadata.plugin.metaDsl.Pattern;
import com.jsantos.metadata.plugin.metaDsl.ShortCode;
import com.jsantos.metadata.plugin.metaDsl.SqlFileDependency;
import com.jsantos.metadata.plugin.validation.helpers.EntityValidator;
import com.jsantos.metadata.plugin.validation.helpers.EnumValidator;

/**
 * This class contains custom validation rules. 
 *
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#validation
 */
public class MetaDslValidator extends AbstractMetaDslValidator {
	
	public static final String FIELD_NAMES_SHOULD_BE_CAMEL_CASE = "Field names should be camel case";
	public static final String ENUMERATION_SHOULD_HAVE_SHORT_CODE = "Enumeration should have a 'shortCode' field of type varchar";
	public static final String ENUMERATION_SHOULD_HAVE_DESCRIPTION = "Enumeration should have a 'description' field of type varchar";
	public static final String ENTITY_DOESN_NOT_MATCH_PATTERN = "Entity definition doesn't match pattern";

	@Check
	public void checkEntityName(Entity entity) {
		Resource resource = entity.eResource(); 
		URI uri = resource.getURI();
		File file = new File(uri.toString());
		String name = file.getName().substring(0, file.getName().lastIndexOf('.'));
		if (!name.equalsIgnoreCase(EntityHelper.getSimpleName(entity)))
			error("File name and Entity name are different for " + entity.getName(), MetaDslPackage.Literals.ENTITY__NAME);
	}
	
	@Check
	public void checkInheritance(Entity entity) {
		if (null != entity.getExtends()) {
			if (EntityHelper.getPks(entity).size()!=1)
				error("Entities marked as extending another entity should have a single primary key: " + entity.getName(), MetaDslPackage.Literals.ENTITY__NAME);
			else {
				if (null == EntityHelper.getPks(entity).get(0).getFkto()  || !EntityHelper.getPks(entity).get(0).getFkto().equals(entity.getExtends())) {
					error("The primary key of " + entity.getName() + " should be a foreign key to  : " + entity.getExtends().getName(), MetaDslPackage.Literals.ENTITY__NAME);
					
				}
			}
		}

	}
	
	
	@Check
	public void checkForPrimaryKey(Entity entity) {
		if (null == entity.getEntityType() || "TABLE".equals(entity.getEntityType())) {
			if (null ==EntityHelper.getSinglePkAttribute(entity))
				warning("Entity " + entity.getName() + " has no primary key", MetaDslPackage.Literals.ENTITY__NAME);
		}
	}

	@Check
	public void checkForForeignKey(Attribute attribute) {
		if (null !=attribute.getFkto() && EntityHelper.getPks(attribute.getFkto()).size()>1)
			error("Entity " + attribute.getFkto().getName() + " has multiple primary keys, can't set a FK to a single one", MetaDslPackage.Literals.ATTRIBUTE__FKTO);
	}	
	
	@Check
	public void checkPatterns(Entity entity) {
		if (null != entity.getPatterns()) {
			for (Pattern pattern:entity.getPatterns()) {
				boolean showError = false;
				for (Attribute patternAttribute:pattern.getAttributes()) {
					if (!PatternHelper.matchAttribute(patternAttribute, entity))
						showError = true;
				}
				if (showError)
					error(entity.getName() + " doesn't match Pattern " + pattern.getName(), MetaDslPackage.Literals.ENTITY__NAME, ENTITY_DOESN_NOT_MATCH_PATTERN);
			}
		}
	}
	
	@Check
	public void checkEnumerationPattern(Entity entity) {
		if(entity.getStereotypes().contains("ENUM")) {
			if (!EntityHelper.getSimpleName(entity).startsWith("Enu"))
				warning("Enumeration name should start with Enu", MetaDslPackage.Literals.ENTITY__NAME);
			if (EntityHelper.getPks(entity).size()>1)
				error("An enumeration can have only one primary key column", MetaDslPackage.Literals.ENTITY__NAME);
			else {
				Attribute pk = EntityHelper.getSinglePkAttribute(entity);
				String pkNamePatern = EntityValidator.calculatePatternPkName(entity);
				if (null != pkNamePatern && !pk.getName().equals(pkNamePatern) )
					warning("Enumeration primary key name should be " + pkNamePatern, MetaDslPackage.Literals.ENTITY__NAME);
			}
			if (!EnumValidator.checkShortCode(entity))
				error("Enumeration should have a 'shortCode' field of type varchar ", MetaDslPackage.Literals.ENTITY__NAME, ENUMERATION_SHOULD_HAVE_SHORT_CODE);
			
			if (!EnumValidator.checkDescription(entity))
				error("Enumeration should have a 'description' field of type varchar ", MetaDslPackage.Literals.ENTITY__NAME, ENUMERATION_SHOULD_HAVE_DESCRIPTION);
		}
	}
	
	@Check
	public void checkEntityStartsWithLowercase(Attribute attribute) {
		if (Character.isUpperCase(attribute.getName().charAt(0))) {
			warning("Field names should be camel case", MetaDslPackage.Literals.ATTRIBUTE__NAME, FIELD_NAMES_SHOULD_BE_CAMEL_CASE);
		}
	}

	@Check
	public void checkNumberOfColumnsInMetadataRow(MetadataRow metadataRow) {
		Entity entity = EntityValidator.getEntityforMetadata((Metadata)metadataRow.eContainer());
		if (entity.getAttributes().size() != metadataRow.getRowValues().size()) {
			error("The number of values doesn't match the number of rows in " + entity.getName(), MetaDslPackage.Literals.METADATA_ROW__ROW_VALUES);
		}
	}
	
	@Check
	public void checkShortCode(ShortCode shortCode) {
		MetadataRowCell cell = (MetadataRowCell)shortCode.eContainer();
		Attribute attribute = EntityHelper.getAttributeForCell(cell);
		if (null == attribute.getFkto()) {
			error(attribute.getName() + " is not a reference", MetaDslPackage.Literals.METADATA_ROW__ROW_VALUES);
		}
		else {
			if (!EntityHelper.getAllShortCodes(attribute.getFkto()).contains(shortCode.getShortCodeValue()))
				error("shortCode " + shortCode.getShortCodeValue() + " doesn't exist in " + attribute.getFkto().getName() + "'s metadata", MetaDslPackage.Literals.SHORT_CODE__SHORT_CODE_VALUE);
		}
	}
	
	@Check
	public void checkDataTypesOfMetadataRow(MetadataRow metadataRow) {
		Entity entity = EntityValidator.getEntityforMetadata((Metadata)metadataRow.eContainer());
		int attributeIndex = 0;
		for (Attribute attribute:entity.getAttributes()) {
			int cellIndex=0;
			for (MetadataRowCell cell:metadataRow.getRowValues()) {
				if (attributeIndex==cellIndex) checkDataTypeOfMetadataCell(attribute, cell, cellIndex);
				cellIndex++;
			}
			attributeIndex++;
		}
	}
	
	@Check
	public void checkPrimaryKeysAreUnique(Metadata metadata) {
		ArrayList<Integer> primaryKeyIndexes = new ArrayList<>();
		int index = 0;
		Entity entity = EntityValidator.getEntityforMetadata(metadata);

		for(Attribute attribute:entity.getAttributes()) {
			if (attribute.isPk()) primaryKeyIndexes.add(index);
			index++;
		}
		
		Vector<String> primaryKeys = new Vector<>();
		int rowIndex = 0;
		for (MetadataRow row:metadata.getMetadataRows()) {
			int cellIndex = 0;
			String primaryKey = "";
			for (MetadataRowCell cell:row.getRowValues()) {
				if (primaryKeyIndexes.contains(cellIndex))
					primaryKey += "[" + cell.getStringValue() + "]";
				cellIndex++;
			}
			if (primaryKeys.contains(primaryKey))
				error("Primary keys are not unique", MetaDslPackage.Literals.METADATA__METADATA_ROWS, rowIndex);
			else
				primaryKeys.add(primaryKey);
			rowIndex++;
		}
	}
	
	@Check
	public void checkSqlFileExists(Entity entity) {
		if (null != entity.getFromSQLFile())
			if (!ResourcesPlugin.getWorkspace().getRoot().getFile(new Path(entity.getFromSQLFile())).exists())
				error("File " + entity.getFromSQLFile() + " doesn't exist", MetaDslPackage.Literals.ENTITY__FROM_SQL_FILE);
			
	}

	@Check
	public void checkSqlFileDependencyFileExists(Entity entity) {
		if (null != entity.getSqlFileDependencies())
			for (SqlFileDependency dependency:entity.getSqlFileDependencies()) {
				if (!ResourcesPlugin.getWorkspace().getRoot().getFile(new Path(dependency.getSqlFileDependency())).exists()) {
					error("Sql Dependency File " + dependency.getSqlFileDependency() + " doesn't exist", MetaDslPackage.Literals.ENTITY__SQL_FILE_DEPENDENCIES, entity.getSqlFileDependencies().indexOf(dependency));
				}
			}
			
	}

	
	@Check
	public void checkEnuMetadata(Metadata metadata) {
		Entity entity= EntityValidator.getEntityforMetadata(metadata);
		if (PatternHelper.entityImplementsPattern(entity, "Enumeration"))
			error("Entity is an enumeration. It should use EnuMetadata", null, null);
		
	}
	
	public void checkDataTypeOfMetadataCell(Attribute attribute, MetadataRowCell cell, int index) {
		//System.out.println("Validating: " + attribute.getName() + " " + attribute.getType().getName());
		//System.out.println(" getStringvalue: " + cell.getStringValue() + " is Null?" + cell.isIsNull() + " is Nullable: " + (null==attribute.getNullable()?"NO":"YES"));
		
		if (cell.isIsNull()) {
			if (attribute.isNotNullable())
				error("Column " + attribute.getName() + " is not nullable", MetaDslPackage.Literals.METADATA_ROW__ROW_VALUES, index);
			else
				return; //no more checks
		}
		
		if (cell.isIsDefault())
			return;
		
		if (null !=attribute.getFkto()){
//			if (null == cell.getRowRefValue())
//				error("Column " + attribute.getName() + " is a Reference" , MetaDslPackage.Literals.METADATA_ROW__ROW_VALUES, index);
			return;
		}

		
		if (null == cell.getStringValue()) {
			error("Column " + attribute.getName() + " is an " + attribute.getType().getName(), MetaDslPackage.Literals.METADATA_ROW__ROW_VALUES, index);
		}
		
		if (null != cell.getStringValue() && null !=attribute.getLength() && cell.getStringValue().length()>Integer.parseInt(attribute.getLength())) {
			error("Column " + attribute.getName() + ". Value is too long", MetaDslPackage.Literals.METADATA_ROW__ROW_VALUES, index);
		}
	}
	
}
