/*
 * generated by Xtext 2.20.0
 */
package com.jsantos.metadata.plugin.ui.quickfix;

import org.eclipse.jface.text.BadLocationException;
import org.eclipse.xtext.resource.XtextResource;
import org.eclipse.xtext.ui.editor.model.IXtextDocument;
import org.eclipse.xtext.ui.editor.model.edit.IModification;
import org.eclipse.xtext.ui.editor.model.edit.IModificationContext;
import org.eclipse.xtext.ui.editor.quickfix.DefaultQuickfixProvider;
import org.eclipse.xtext.ui.editor.quickfix.Fix;
import org.eclipse.xtext.ui.editor.quickfix.IssueResolutionAcceptor;
import org.eclipse.xtext.util.concurrent.IUnitOfWork;
import org.eclipse.xtext.validation.Issue;

import com.jsantos.metadata.plugin.accessors.PatternHelper;
import com.jsantos.metadata.plugin.metaDsl.Attribute;
import com.jsantos.metadata.plugin.metaDsl.ColumnStereotype;
import com.jsantos.metadata.plugin.metaDsl.Entity;
import com.jsantos.metadata.plugin.metaDsl.MetaDslFactory;
import com.jsantos.metadata.plugin.metaDsl.Pattern;
import com.jsantos.metadata.plugin.validation.MetaDslValidator;

/**
 * Custom quickfixes.
 *
 * See https://www.eclipse.org/Xtext/documentation/310_eclipse_support.html#quick-fixes
 */
public class MetaDslQuickfixProvider extends DefaultQuickfixProvider {

	@Fix(MetaDslValidator.FIELD_NAMES_SHOULD_BE_CAMEL_CASE)
	public void capitalizeName(final Issue issue, IssueResolutionAcceptor acceptor) {
		acceptor.accept(issue, "Change first letter to lowercase", "Change first letter to lowercase.", null, new IModification() {
			public void apply(IModificationContext context) throws BadLocationException {
				IXtextDocument xtextDocument = context.getXtextDocument();
				String firstLetter = xtextDocument.get(issue.getOffset(), 1);
				xtextDocument.replace(issue.getOffset(), 1, firstLetter.toLowerCase());
			}
		});
	}

	@Fix(MetaDslValidator.ENUMERATION_SHOULD_HAVE_SHORT_CODE)
	public void addShortCode(final Issue issue, final IssueResolutionAcceptor acceptor) {
		acceptor.accept(issue, "Add shortCode field", "add shortCode Field", null, new IModification() {
			@Override
			public void apply(final IModificationContext context) throws BadLocationException {
				context.getXtextDocument().modify(new IUnitOfWork<Void, XtextResource>() {
					@Override
					public java.lang.Void exec(final XtextResource state) {
						Entity entity = (Entity) state.getEObject(issue.getUriToProblem().fragment());
						Attribute attribute = MetaDslFactory.eINSTANCE.createAttribute();
						attribute.setName("shortCode");
						//	          attribute.setType(value);
						//	          DataTypeWithLength dataType = MetaDslFactory.eINSTANCE.createDataTypeWithLength();
						//	          dataType.setName("VARCHAR");
						//	          dataType.setLength("8");
						//	          attribute.setType(dataType);
						entity.getAttributes().add(1, attribute);
						return null;
					}
				});
			}
		});
	}

	@Fix(MetaDslValidator.ENTITY_DOESN_NOT_MATCH_PATTERN)
	public void addPatternFields(final Issue issue, final IssueResolutionAcceptor acceptor) {
		acceptor.accept(issue, "Add Pattern Fields", "Add Pattern Fields", null, new IModification() {
			@Override
			public void apply(final IModificationContext context) throws BadLocationException {
				context.getXtextDocument().modify(new IUnitOfWork<Void, XtextResource>() {
					@Override
					public java.lang.Void exec(final XtextResource state) {

						Entity entity = (Entity) state.getEObject(issue.getUriToProblem().fragment());
						for (Pattern pattern:entity.getPatterns()) {
							for (Attribute patternAttribute:pattern.getAttributes()){
								if (!PatternHelper.matchAttribute(patternAttribute, entity)) {
									Attribute attribute = MetaDslFactory.eINSTANCE.createAttribute();
									attribute.setName(patternAttribute.getName());
									attribute.setType(patternAttribute.getType());
									attribute.setNotNullable(patternAttribute.isNotNullable());
									attribute.setLength(patternAttribute.getLength());
									attribute.setScale(patternAttribute.getScale());
									attribute.setPk(patternAttribute.isPk());
									attribute.setFkto(patternAttribute.getFkto());
									attribute.setDefault(patternAttribute.getDefault());
									attribute.setUnique(patternAttribute.isUnique());
									
									if (null !=patternAttribute.getStereotypes()) {
										for (ColumnStereotype columnStereotype:patternAttribute.getStereotypes())
											attribute.getStereotypes().add(columnStereotype);
										
									}
									entity.getAttributes().add(attribute);
								}
							}
							entity.setName(entity.getName());
						}
						return null;
					}
				});
			}
		});
	}

	@Fix(MetaDslValidator.ENUMERATION_SHOULD_HAVE_DESCRIPTION)
	public void addDescription(final Issue issue, final IssueResolutionAcceptor acceptor) {
		acceptor.accept(issue, "Add description field", "add description Field", null, new IModification() {
			@Override
			public void apply(final IModificationContext context) throws BadLocationException {
				context.getXtextDocument().modify(new IUnitOfWork<Void, XtextResource>() {
					@Override
					public java.lang.Void exec(final XtextResource state) {
						Entity entity = (Entity) state.getEObject(issue.getUriToProblem().fragment());
						Attribute attribute = MetaDslFactory.eINSTANCE.createAttribute();
						attribute.setName("description");
						//	          DataTypeWithLength dataType = MetaDslFactory.eINSTANCE.createDataTypeWithLength();
						//	          dataType.setName("VARCHAR");
						//	          dataType.setLength("64");
						//	          attribute.setType(dataType);
						entity.getAttributes().add(2, attribute);
						return null;
					}
				});
			}
		});
	}

}
